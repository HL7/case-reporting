<?xml version="1.0" encoding="UTF-8"?>
<Bundle xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://hl7.org/fhir ../../../validation/fhir-all.xsd"
    xmlns="http://hl7.org/fhir">
    <id value="ecr-bundle-knowledge-distribution" />
    <type value="collection" />
    <!-- Knowledge Distribution Plan Definition instance -->
    <entry>
        <fullUrl value="http://hl7.org/fhir/us/ecr/PlanDefinition/ecr-knowledge-distribution" />
        <resource>
            <PlanDefinition>
                <id value="ecr-knowledge-distribution-instance" />
                <meta>
                    <profile value="http://hl7.org/fhir/us/ecr/StructureDefinition/ecr-knowledge-distribution-plandefinition" />
                </meta>
                <version value="0.1" />
                <title value="Knowledge Definition Sample Instance" />
                <type>
                    <coding>
                        <system value="http://hl7.org/fhir/plan-definition-type" />
                        <code value="eca-rule" />
                        <display value="ECA Rule" />
                    </coding>
                </type>
                <status value="draft" />
                <relatedArtifact>
                    <type value="depends-on"/>
                    <resource>
                        <reference value="http://hl7.org/fhir/us/ecr/Library/rctc"/>
                        <display value="RCTC Value Set Bundle of Trigger Codes"/>
                    </resource>
                </relatedArtifact>
                <library>
                    <reference value="Knowledge_Distribution_Logic.cql" />
                </library>
                <action id="Orchestration">
                    <!--
                    New Hierarchy:
                    top level Action that contains:
                    Triggering in the triggerDefinition elements
                    Orchestration that decides between healthcare-based rules and AIMS platform rules
                    Sub Actions:
                        Healthcare-based Rules Processing
                        Sub-actions:
                            Rules Processing
                            Prepare Clinical Feedback
                            Creation of eICR
                            Routing and Sending
                        RCKMS Rules Processing on AIMS Platform:
                        Sub Actions:
                            Creation of eICR
                            Sending from Clinical Care to Platform
                            Platform rules processing
                            Prepare Clinical Feedback (Creation of RR) 
                    -->
                    <textEquivalent value="Pick between the two sequence options based on rules processing: Healthcare-based processing, or RCKMS Rules Processing on AIMS Platform"/>
                    <triggerDefinition>
                        <type value="data-added" />
                        <eventName value="Diagnoses or problems documented in a clinical record." />
                        <eventData>
                            <type value="Condition" />
                            <codeFilter>
                                <path value="code" />
                                <valueSetReference>
                                    <reference value="diagnosis-value-set" />
                                </valueSetReference>
                            </codeFilter>
                        </eventData>
                    </triggerDefinition>
                    <triggerDefinition>
                        <type value="data-added" />
                        <eventName value="Nominal laboratory result values documented in a clinical record." />
                        <eventData>
                            <type value="Observation" />
                            <codeFilter>
                                <path value="valueCodeableConcept" />
                                <valueSetReference>
                                    <reference value="organism-substance-value-set" />
                                </valueSetReference>
                            </codeFilter>
                        </eventData>
                    </triggerDefinition>
                    <triggerDefinition>
                        <type value="data-added" />
                        <eventName value="Laboratory test names used in orders documented in a clinical record." />
                        <eventData>
                            <type value="Procedure Request" />
                            <codeFilter>
                                <path value="code" />
                                <valueSetReference>
                                    <reference value="lab-order-test-name-value-set" />
                                </valueSetReference>
                            </codeFilter>
                        </eventData>
                    </triggerDefinition>
                    <triggerDefinition>
                        <type value="data-added" />
                        <eventName value="Laboratory test names used in observations documented in a clinical record." />
                        <eventData>
                            <type value="Observation" />
                            <codeFilter>
                                <path value="code" />
                                <valueSetReference>
                                    <reference value="lab-observation-test-name-value-set" />
                                </valueSetReference>
                            </codeFilter>
                        </eventData>
                    </triggerDefinition>
                    
                    <selectionBehavior value="exactly-one"/>
                    <!-- Healthcare-based Rules Processing -->
                    <action>
                        <description value="Healthcare-based Rules processing workflow"/>
                        <condition>
                            <kind value="applicability"/>
                            <description value="healthcare facility has rules processing capability"/>
                        </condition>
                        <action>
                            <textEquivalent value="Rules Processing is executed on Healthcare platform"/>
                            <triggerDefinition>
                                <type value="named-event"/>
                                <eventName value="orchestration is completed"/>
                            </triggerDefinition>
                        </action>
                        <action>
                            <!--Creation of Clinical Feedback-->
                            <textEquivalent value="create clinical feedback per rules"/>
                            <triggerDefinition>
                                <type value="named-event"/>
                                <eventName value="rules processing is completed"/>
                            </triggerDefinition>
                            <condition>
                                <kind value="applicability"/>
                                <description value="If rules processing determines reportable or may be reportable, then create clinical feedback"></description>
                            </condition>
                        </action>
                        <action>
                            <!-- Creation of EICR -->
                            <selectionBehavior value="at-most-one"/>
                            <action>
                                <!--Initial Creation of eICR-->
                                <textEquivalent value="delay eICR construction (x hours) -  time after the start of the encounter before a triggered eICR should be composed and sent"/>
                                <triggerDefinition>
                                    <type value="named-event"/>
                                    <eventName value="Trigger code match"/>
                                    <eventTimingTiming>
                                        <repeat>
                                            <offset value="360"/>
                                        </repeat>
                                    </eventTimingTiming>
                                </triggerDefinition>                               
                                <definition>
                                    <!-- this will point to the same activity definition: create eicr. -->
                                </definition>
                            </action>
                            <action>
                                <!-- eicr periodic update -->
                                <textEquivalent value="eICR periodic update (y hours) – the time after an initial eICR transmission to send new eICRs as updates for long episodes of care"/>
                                <triggerDefinition>
                                    <type value="periodic"/>
                                    <eventTimingTiming>
                                        <repeat>
                                            <frequency value="1"/>
                                            <period value="48"/>
                                            <periodUnit value="h"/>
                                        </repeat>
                                    </eventTimingTiming>
                                </triggerDefinition>
                                <condition>
                                    <kind value="applicability"/>
                                    <description value="A trigger code was matched, episode of care is still active, and 48 hours have passed after the last eicr was sent"/>
                                </condition>
                                <condition>
                                    <kind value="stop"/>
                                    <description value="episode of care is closed out"/>
                                </condition>
                                <definition>
                                    <!-- this will point to the same activity definition: create eicr. -->
                                </definition>
                            </action>
                            <action>
                                <!-- eicr episode of care close out -->
                                <textEquivalent value="eICR episode of care close out (z hours) – the time after the end of an episode of care for a final eICR will be sent when there has been one or more trigger events"/>
                                <triggerDefinition>
                                    <type value="named-event"/>
                                    <eventName value="Episode of Care close out"/>
                                    <eventTimingTiming>
                                        <repeat>
                                            <offset value="360"/>
                                        </repeat>
                                    </eventTimingTiming>
                                </triggerDefinition>
                                <condition>
                                    <kind value="applicability"/>
                                    <description value="there has been one or more trigger events"/>
                                </condition>
                                <definition>
                                    <!-- this will point to the same activity definition: create eicr. -->
                                </definition>
                            </action>
                        </action>
                        <action>
                            <!--Routing and Sending-->
                            <textEquivalent value="Route and send eicr per rules processing"/>
                            <triggerDefinition>
                                <type value="named-event"/>
                                <eventName value="creation of eicr complete"/>
                            </triggerDefinition>
                            <condition>
                                <kind value="applicability"/>
                                <expression value="RoutingSending() == true"/>
                            </condition>
                        </action>
                    </action>
                    <!-- Platform-based Rules Processing -->
                    <action>
                        <description value="Platform-based Rules processing workflow"/>
                        <action>
                            <selectionBehavior value="at-most-one"/>
                            <action>
                                <!--Creation of eICR-->
                                <textEquivalent value="eICR construction and send delay (x hours) -  time after the start of the encounter before a triggered eICR should be composed and sent"/>
                                <triggerDefinition>
                                    <type value="named-event"/>
                                    <eventName value="Trigger code match"/>
                                    <eventTimingTiming>
                                        <repeat>
                                            <offset value="360"/>
                                        </repeat>
                                    </eventTimingTiming>
                                </triggerDefinition>                               
                                <definition>
                                    <!-- this will point to the same activity definition: create eicr. -->
                                </definition>
                            </action>
                            <action>
                                <!-- eicr periodic update -->
                                <textEquivalent value="eICR periodic update (y hours) – the time after an initial eICR transmission to send new eICRs as updates for long episodes of care"/>
                                <triggerDefinition>
                                    <type value="periodic"/>
                                    <eventTimingTiming>
                                        <repeat>
                                            <frequency value="1"/>
                                            <period value="8"/>
                                            <periodUnit value="h"/>
                                        </repeat>
                                    </eventTimingTiming>
                                </triggerDefinition>
                                <condition>
                                    <kind value="applicability"/>
                                    <description value="A trigger code was matched, episode of care is still active, and Y hours have passed after the last eicr was sent"/>
                                </condition>
                                <condition>
                                    <kind value="stop"/>
                                    <description value="episode of care is closed out"/>
                                </condition>
                                <definition>
                                    <!-- this will point to the same activity definition: create eicr. -->
                                </definition>
                            </action>
                            <action>
                                <!-- eicr episode of care close out -->
                                <textEquivalent value="eICR episode of care close out (z hours) – the time after the end of an episode of care for a final eICR will be sent when there has been one or more trigger events"/>
                                <triggerDefinition>
                                    <type value="named-event"/>
                                    <eventName value="Episode of Care close out"/>
                                    <eventTimingTiming>
                                        <repeat>
                                            <offset value="360"/>
                                        </repeat>
                                    </eventTimingTiming>
                                </triggerDefinition>
                                <condition>
                                    <kind value="applicability"/>
                                    <description value="there has been one or more trigger events"/>
                                </condition>
                                <definition>
                                    <!-- this will point to the same activity definition: create eicr. -->
                                </definition>
                            </action>
                        </action>
                        <action>
                            <!--Sending from Clinical Care to Platform-->
                            <textEquivalent value="Send from clinical care to platform"/>
                            <triggerDefinition>
                                <type value="named-event"/>
                                <eventName value="Creation of eICR complete"/>
                            </triggerDefinition>
                        </action>
                        <action>
                            <!--Platform Rules Processing-->
                            <textEquivalent value="Platform rules processing"/>
                            <triggerDefinition>
                                <type value="named-event"/>
                                <eventName value="eICR Received"/>
                            </triggerDefinition>
                        </action>
                        <action>
                            <!--Creation of Clinical Feedback-->
                            <textEquivalent value="create clinical feedback per rules"/>
                            <triggerDefinition>
                                <type value="named-event"/>
                                <eventName value="rules processing complete"/>
                            </triggerDefinition>
                        </action>
                        
                    </action>
                </action>
            </PlanDefinition>
        </resource>
    </entry>
</Bundle>
