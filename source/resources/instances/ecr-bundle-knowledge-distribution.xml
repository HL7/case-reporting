<?xml version="1.0" encoding="UTF-8"?>
<Bundle xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://hl7.org/fhir ../../../validation/fhir-all.xsd"
  xmlns="http://hl7.org/fhir">
  <id value="ecr-bundle-knowledge-distribution" />
  <type value="collection" />
  <!-- Knowledge Distribution Plan Definition instance 
        Knowledge Distribution Hierarchy:
        top level Action that contains:
        Triggering in the triggerDefinition elements
        Orchestration that decides between healthcare-based rules and AIMS platform rules
        Sub Actions:
            Healthcare-based Rules Processing
            Sub-actions:
                Rules Processing
                Prepare Clinical Feedback
                Creation of eICR
                Routing and Sending
            RCKMS Rules Processing on AIMS Platform:
            Sub Actions:
                Creation of eICR
                Sending from Clinical Care to Platform
                Platform rules processing
                Prepare Clinical Feedback (Creation of RR) 
     -->
  <entry>
    <fullUrl value="http://hl7.org/fhir/us/ecr/PlanDefinition/ecr-knowledge-distribution" />
    <resource>
      <PlanDefinition>
        <id value="ecr-knowledge-distribution-instance" />
        <meta>
          <profile value="http://hl7.org/fhir/us/ecr/StructureDefinition/ecr-knowledge-distribution" />
        </meta>
        <version value="0.1" />
        <name value="ecr-knowledge-distribution" />
        <title value="Knowledge Definition Sample Instance" />
        <type>
          <coding>
            <system value="http://hl7.org/fhir/plan-definition-type" />
            <code value="eca-rule" />
            <display value="ECA Rule" />
          </coding>
        </type>
        <status value="draft" />
        <date value="2018-08-19" />
        <effectivePeriod>
          <start value="2018-09-01" />
        </effectivePeriod>
        <relatedArtifact>
          <type value="depends-on" />
          <display value="RCTC Value Set Bundle of Trigger Codes" />
          <resource>
            <reference value="http://hl7.org/fhir/us/ecr/Library/rctc" />
          </resource>
        </relatedArtifact>
        <!-- IF there's a logic library that defines the expressions for triggers, conditions and actions in this plan definition, it's linked here.
                    <library>
                    <reference value="Knowledge_Distribution_Logic.cql"/>
                </library>-->
        <!-- Orchestration Action: Decides between Healthcare-based Rules Processing or RCKMS Rules Processing on AIMS Platform -->
        <action id="orchestration">
          <description value="orchestration" />
          <textEquivalent
            value="Pick between the two sequence options based on rules processing: Healthcare-based processing, or RCKMS Rules Processing on AIMS Platform" />
          <triggerDefinition id="diagnosis">
            <type value="data-added" />
            <eventName value="Diagnoses or problems documented in a clinical record." />
            <eventData>
              <type value="Condition" />
              <codeFilter>
                <path value="code" />
                <valueSetReference>
                  <reference value="http://hl7.org/fhir/us/ecr/ValueSet/dxtc" />
                </valueSetReference>
              </codeFilter>
            </eventData>
          </triggerDefinition>
          <triggerDefinition id="organism-substance">
            <type value="data-added" />
            <eventName value="Nominal laboratory result values documented in a clinical record." />
            <eventData>
              <type value="Observation" />
              <codeFilter>
                <path value="valueCodeableConcept" />
                <valueSetReference>
                  <reference value="http://hl7.org/fhir/us/ecr/ValueSet/ostc" />
                </valueSetReference>
              </codeFilter>
            </eventData>
          </triggerDefinition>
          <triggerDefinition id="lab-order-test">
            <type value="data-added" />
            <eventName value="Laboratory test names used in orders documented in a clinical record." />
            <eventData>
              <type value="Procedure Request" />
              <codeFilter>
                <path value="code" />
                <valueSetReference>
                  <reference value="http://hl7.org/fhir/us/ecr/ValueSet/lotc" />
                </valueSetReference>
              </codeFilter>
            </eventData>
          </triggerDefinition>
          <triggerDefinition id="lab-obs-test">
            <type value="data-added" />
            <eventName value="Laboratory test names used in observations documented in a clinical record." />
            <eventData>
              <type value="Observation" />
              <codeFilter>
                <path value="code" />
                <valueSetReference>
                  <reference value="http://hl7.org/fhir/us/ecr/ValueSet/lrtc" />
                </valueSetReference>
              </codeFilter>
            </eventData>
          </triggerDefinition>
          <triggerDefinition id="prescription-drugs">
            <type value="data-added" />
            <eventName value="Prescription drugs names used in observations documented in a clinical record." />
            <eventData>
              <type value="Medication" />
              <codeFilter>
                <path value="code" />
                <valueSetReference>
                  <!-- NOTE: This is the wrong value set - the value doesn't exist yet -->
                  <reference value="http://hl7.org/fhir/us/ecr/ValueSet/lrtc" />
                </valueSetReference>
              </codeFilter>
            </eventData>
          </triggerDefinition>
          <!-- Select b/w the two types of Rules Processing.  -->
          <selectionBehavior value="exactly-one" />
          <!-- Healthcare-based Rules Processing -->
          <action id="healthcare-based">
            <description value="Healthcare-based Rules processing workflow" />
            <textEquivalent value="Rules processing, clinical feedback, eicr, route and send" />
            <condition>
              <kind value="applicability" />
              <description value="healthcare facility has rules processing capability" />
            </condition>
            <action id="rules-processing">
              <description value="Rules processing" />

              <textEquivalent value="Rules Processing is executed on Healthcare platform" />
              <triggerDefinition>
                <type value="named-event" />
                <eventName value="orchestration is completed" />
              </triggerDefinition>
            </action>
            <action id="clinical-feedback">
              <!--Creation of Clinical Feedback-->
              <description value="clinical feedback" />
              <textEquivalent value="create clinical feedback per rules" />
              <triggerDefinition>
                <type value="named-event" />
                <eventName value="rules processing is completed" />
              </triggerDefinition>
              <condition>
                <kind value="applicability" />
                <description value="If rules processing determines reportable or may be reportable, then create clinical feedback" />
              </condition>
            </action>
            <action id="eicr">
              <description value="eicr" />
              <textEquivalent value="create: initial eicr, periodic update eicr, close out eicr" />
              <!-- Creation of EICR -->
              <selectionBehavior value="at-most-one" />
              <action id="create-eicr">
                <!--Initial Creation of eICR-->
                <description value="Initial creation of eICR" />
                <textEquivalent
                  value="delay eICR construction (x hours) -  time after the start of the encounter before a triggered eICR should be composed and sent" />
                <triggerDefinition>
                  <type value="named-event" />
                  <eventName value="Trigger code match" />
                  <eventTimingTiming>
                    <repeat>
                      <offset value="360" />
                    </repeat>
                  </eventTimingTiming>
                </triggerDefinition>
                <!--<definition>
                                    <!-\\- this will point to the same activity definition: create eicr. -\\->
                                </definition>-->
              </action>
              <action id="periodic-eicr">
                <!-- eicr periodic update -->
                <description value="eICR periodic update" />
                <textEquivalent
                  value="eICR periodic update (y hours) – the time after an initial eICR transmission to send new eICRs as updates for long episodes of care" />
                <triggerDefinition>
                  <type value="periodic" />
                  <eventTimingTiming>
                    <repeat>
                      <frequency value="1" />
                      <period value="48" />
                      <periodUnit value="h" />
                    </repeat>
                  </eventTimingTiming>
                </triggerDefinition>
                <condition>
                  <kind value="applicability" />
                  <description
                    value="A trigger code was matched, episode of care is still active, and 48 hours have passed after the last eicr was sent" />
                </condition>
                <condition>
                  <kind value="stop" />
                  <description value="episode of care is closed out" />
                </condition>
                <!--<definition>
                                    <!-\\- this will point to the same activity definition: create eicr. -\\->
                                </definition>-->
              </action>
              <action id="close-out-eicr">
                <!-- eicr episode of care close out -->
                <description value="eICR episode of care close out" />
                <textEquivalent
                  value="eICR episode of care close out (z hours) – the time after the end of an episode of care for a final eICR will be sent when there has been one or more trigger events" />
                <triggerDefinition>
                  <type value="named-event" />
                  <eventName value="Episode of Care close out" />
                  <eventTimingTiming>
                    <repeat>
                      <offset value="360" />
                    </repeat>
                  </eventTimingTiming>
                </triggerDefinition>
                <condition>
                  <kind value="applicability" />
                  <description value="there has been one or more trigger events" />
                </condition>
                <!--<definition>
                                    <!-\\- this will point to the same activity definition: create eicr. -\\->
                                </definition>-->
              </action>
            </action>
            <action id="route-and-send">
              <!--Routing and Sending-->
              <description value="route and sent eicr" />
              <textEquivalent value="Route and send eicr per rules processing" />
              <triggerDefinition>
                <type value="named-event" />
                <eventName value="creation of eicr complete" />
              </triggerDefinition>
              <condition>
                <kind value="applicability" />
                <expression value="RoutingSending() == true" />
              </condition>
            </action>
          </action>
          <!-- RCKMS Rules Processing on AIMS Platform -->
          <action id="aims-platform-rules-processing">
            <description value="Platform-based Rules processing workflow" />
            <textEquivalent value="eicr, send from clinical care to platform, platform rules-processing, creation of clinical feedback" />
            <action id="eicr">
              <description value="eicr" />
              <textEquivalent value="create: initial eicr, periodic update eicr, close out eicr" />
              <selectionBehavior value="at-most-one" />
              <action id="create-eicr">
                <!--Creation of eICR-->
                <description value="create eicr" />
                <textEquivalent
                  value="eICR construction and send delay (x hours) -  time after the start of the encounter before a triggered eICR should be composed and sent" />
                <triggerDefinition>
                  <type value="named-event" />
                  <eventName value="Trigger code match" />
                  <eventTimingTiming>
                    <repeat>
                      <offset value="360" />
                    </repeat>
                  </eventTimingTiming>
                </triggerDefinition>
                <!--<definition>
                                    <!-\\- this will point to the same activity definition: create eicr. -\\->
                                </definition>-->
              </action>
              <action id="periodic-eicr">
                <!-- eicr periodic update -->
                <description value="period update eicr" />
                <textEquivalent
                  value="eICR periodic update (y hours) – the time after an initial eICR transmission to send new eICRs as updates for long episodes of care" />
                <triggerDefinition>
                  <type value="periodic" />
                  <eventTimingTiming>
                    <repeat>
                      <frequency value="1" />
                      <period value="8" />
                      <periodUnit value="h" />
                    </repeat>
                  </eventTimingTiming>
                </triggerDefinition>
                <condition>
                  <kind value="applicability" />
                  <description
                    value="A trigger code was matched, episode of care is still active, and Y hours have passed after the last eicr was sent" />
                </condition>
                <condition>
                  <kind value="stop" />
                  <description value="episode of care is closed out" />
                </condition>
                <!--<definition>
                                    <!-\\- this will point to the same activity definition: create eicr. -\\->
                                </definition>-->
              </action>
              <action id="close-out-eicr">
                <!-- eicr episode of care close out -->
                <description value="close out eicr" />
                <textEquivalent
                  value="eICR episode of care close out (z hours) – the time after the end of an episode of care for a final eICR will be sent when there has been one or more trigger events" />
                <triggerDefinition>
                  <type value="named-event" />
                  <eventName value="Episode of Care close out" />
                  <eventTimingTiming>
                    <repeat>
                      <offset value="360" />
                    </repeat>
                  </eventTimingTiming>
                </triggerDefinition>
                <condition>
                  <kind value="applicability" />
                  <description value="there has been one or more trigger events" />
                </condition>
                <!--<definition>
                                    <!-\\- this will point to the same activity definition: create eicr. -\\->
                                </definition>-->
              </action>
            </action>
            <action id="send-clinical-care-platform">
              <!--Sending from Clinical Care to Platform-->
              <description value="send eicr from clinical care to platform" />
              <textEquivalent value="Send from clinical care to platform" />
              <triggerDefinition>
                <type value="named-event" />
                <eventName value="Creation of eICR complete" />
              </triggerDefinition>
            </action>
            <action id="platform-rules-processing">
              <!--Platform Rules Processing-->
              <description value="platform rules processing" />
              <textEquivalent value="Platform rules processing" />
              <triggerDefinition>
                <type value="named-event" />
                <eventName value="eICR Received" />
              </triggerDefinition>
            </action>
            <action id="create-clinical-feedback">
              <!--Creation of Clinical Feedback-->
              <description value="create clinical feedback per results of rules processing" />
              <textEquivalent value="create clinical feedback per rules" />
              <triggerDefinition>
                <type value="named-event" />
                <eventName value="rules processing complete" />
              </triggerDefinition>
            </action>
          </action>
        </action>
      </PlanDefinition>
    </resource>
  </entry>
</Bundle>
